<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Contrôle Maison MQTT</title>

<style>
  body {
    font-family: Arial;
    text-align: center;
    background: #f0f0f0;
  }

  .btn {
    padding: 20px;
    margin: 10px;
    width: 200px;
    font-size: 18px;
  }

  .on {
    background: green;
    color: white;
  }

  .off {
    background: red;
    color: white;
  }

  .disconnect {
    background: gray;
    color: white;
  }

  #connexion {
    font-weight: bold;
    font-size: 20px;
  }
</style>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>

let client = mqtt.connect("wss://test.mosquitto.org:8081");

let etats = [false, false, false];

let derniereReception = Date.now();

// ---- Connexion MQTT ----
client.on("connect", function () {
  console.log("Connecté au broker MQTT");

  client.subscribe("maison/#");
});

// ---- Réception des messages ----
client.on("message", function (topic, message) {

  derniereReception = Date.now();

  let msg = message.toString();

  for (let i = 1; i <= 3; i++) {
    if (topic === "maison/lampe" + i + "/etat") {
      etats[i-1] = (msg === "ON");
      majBoutons();
    }
  }

  if (topic === "maison/connexion/etat") {
    document.getElementById("connexion").innerHTML = "CONNECTÉ";
    document.getElementById("connexion").style.color = "green";
  }
});

// ---- Envoyer commande ----
function envoyer(i) {
  let cmd = etats[i] ? "OFF" : "ON";
  client.publish("maison/lampe" + (i+1) + "/cmd", cmd);
}

// ---- Mettre à jour boutons ----
function majBoutons() {
  for (let i = 0; i < 3; i++) {
    let b = document.getElementById("b" + i);

    if (etats[i]) {
      b.innerHTML = "Lampe " + (i+1) + " ON";
      b.className = "btn on";
    } else {
      b.innerHTML = "Lampe " + (i+1) + " OFF";
      b.className = "btn off";
    }
  }
}

// ---- Vérification périodique de connexion ----
function verifierConnexion() {

  let maintenant = Date.now();

  // Si aucune donnée reçue depuis 10 secondes
  if (maintenant - derniereReception > 10000) {

    document.getElementById("connexion").innerHTML = "DÉCONNECTÉ";
    document.getElementById("connexion").style.color = "red";

    // Griser les boutons
    for (let i = 0; i < 3; i++) {
      let b = document.getElementById("b" + i);
      b.className = "btn disconnect";
    }
  }
}

// ---- Rafraîchissement automatique ----
setInterval(verifierConnexion, 5000);

</script>

</head>

<body>

<h2>Contrôle des Lampes MQTT</h2>

<button id="b0" class="btn off" onclick="envoyer(0)">Lampe 1</button><br>
<button id="b1" class="btn off" onclick="envoyer(1)">Lampe 2</button><br>
<button id="b2" class="btn off" onclick="envoyer(2)">Lampe 3</button><br>

<h3>Connexion ESP8266 : <span id="connexion">---</span></h3>

</body>
</html>
